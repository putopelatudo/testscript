#!/bin/bash

# Проверка на запуск от root
if [ "$(id -u)" -ne 0 ]; then
    echo "Этот скрипт должен запускаться от root (используйте sudo)."
    exit 1
fi

# =================================================================
# НАЧАЛО: Блок назначения паролей (перемещен в начало скрипта)
# =================================================================

# 1. Смена пароля для root
echo "------------------------------------------------------------"
echo "--- НАЗНАЧЕНИЕ НОВОГО ПАРОЛЯ ДЛЯ ПОЛЬЗОВАТЕЛЯ ROOT ---"
echo "------------------------------------------------------------"
while true; do
    read -s -p "Введите новый сложный пароль для root: " PASSWORD_ROOT
    echo
    read -s -p "Подтвердите пароль для root: " PASSWORD_ROOT_CONFIRM
    echo

    if [ "$PASSWORD_ROOT" == "$PASSWORD_ROOT_CONFIRM" ]; then
        echo "root:$PASSWORD_ROOT" | chpasswd
        if [ $? -eq 0 ]; then
            echo "Пароль для пользователя root успешно изменён."
        else
            echo "ОШИБКА: Не удалось сменить пароль для root. Проверьте логи."
            exit 1
        fi
        break
    else
        echo "Пароли не совпадают. Попробуйте заново."
    fi
done
echo


# 2. Функция для создания/обновления пользователя с паролем и добавлением в sudo
create_user() {
    local USER=$1

    if id -u "$USER" > /dev/null 2>&1; then
        echo "Пользователь '$USER' уже существует. Обновляем пароль."
    else
        echo "Создание нового пользователя '$USER'..."
        adduser --gecos "" --disabled-password "$USER"
    fi
    
    # Запрос и установка пароля для пользователя
    while true; do
        read -s -p "Введите новый пароль для пользователя '$USER': " PASS
        echo
        read -s -p "Подтвердите пароль для '$USER': " PASS_CONFIRM
        echo

        if [ "$PASS" == "$PASS_CONFIRM" ]; then
            echo "$USER:$PASS" | chpasswd
            echo "Пароль для пользователя '$USER' успешно установлен/обновлён."
            break
        else
            echo "Пароли не совпадают. Попробуйте заново."
        fi
    done

    # Добавление в группу sudo (если ещё не в ней)
    if ! groups "$USER" | grep -q sudo; then
        usermod -aG sudo "$USER"
        echo "Пользователь '$USER' добавлен в группу sudo."
    else
        echo "Пользователь '$USER' уже в группе sudo."
    fi
    echo
}

# Создание/обновление пользователей
echo "--- НАЗНАЧЕНИЕ ПАРОЛЕЙ ДЛЯ ОСТАЛЬНЫХ ПОЛЬЗОВАТЕЛЕЙ ---"
create_user "putopelatudo"
create_user "reserveme"


# =================================================================
# КОНЕЦ: Блок назначения паролей
# =================================================================


# Обновление списка пакетов и upgrade системы
echo "------------------------------------------------------------"
echo "--- ОБНОВЛЕНИЕ СИСТЕМЫ ---"
echo "------------------------------------------------------------"
echo "Обновление списка пакетов..."
apt update -y
echo "Обновление установленных пакетов..."
apt upgrade -y

# Отключение IPv6
echo "------------------------------------------------------------"
echo "--- ОТКЛЮЧЕНИЕ IPv6 ---"
echo "------------------------------------------------------------"
echo "Проверка текущего состояния IPv6..."
ip a | grep inet6 || echo "IPv6 уже отключен или не найден."

echo "Создание конфигурационного файла для отключения IPv6..."
cat << EOF > /etc/sysctl.d/10-disable-ipv6.conf
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
EOF

echo "Применение изменений..."
sysctl -p /etc/sysctl.d/10-disable-ipv6.conf

echo "Проверка состояния IPv6 после отключения..."
ip a | grep inet6 || echo "IPv6 успешно отключен (нет записей inet6)."

echo "------------------------------------------------------------"
echo "Установка и первоначальная настройка завершена!"
echo "------------------------------------------------------------"
